name: Terraform Module Tests

on:
  pull_request:
    paths:
      - 'terraform/**'
  push:
    branches:
      - main
    paths:
      - 'terraform/**'

jobs:
  discover-modules:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-matrix.outputs.modules }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to detect changes

      - name: Detect changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare with base branch
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For pushes, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Discover test modules for changed files
        id: set-matrix
        run: |
          # Get changed files from previous step
          CHANGED_FILES='${{ steps.changed-files.outputs.changed_files }}'

          # Find all test modules
          ALL_TEST_MODULES=$(find terraform -type f -name "main.tf" -path "*/tests/*" -exec dirname {} \; | sort -u)

          # Filter to only modules where files changed
          FILTERED_MODULES=""
          while IFS= read -r module; do
            # Extract module path (remove /tests/xxx part)
            MODULE_ROOT=$(echo "$module" | sed 's|/tests/.*||')

            # Check if any changed file belongs to this module
            if echo "$CHANGED_FILES" | grep -q "^$MODULE_ROOT/"; then
              FILTERED_MODULES="$FILTERED_MODULES$module"$'\n'
            fi
          done <<< "$ALL_TEST_MODULES"

          # Convert to JSON array
          if [ -z "$FILTERED_MODULES" ]; then
            modules="[]"
          else
            modules=$(echo "$FILTERED_MODULES" | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
          fi

          echo "modules=$modules" >> $GITHUB_OUTPUT
          echo "Found test modules for changed files:"
          echo "$modules" | jq

  module-tests:
    needs: discover-modules
    if: needs.discover-modules.outputs.modules != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        module: ${{ fromJson(needs.discover-modules.outputs.modules) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.7

      - name: Module Info
        run: |
          echo "Testing module: ${{ matrix.module }}"
          ls -la ${{ matrix.module }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.module }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ matrix.module }}

      - name: Terraform Plan
        run: terraform plan -out=plan.out
        working-directory: ${{ matrix.module }}
        env:
          # These mock credentials are used for planning without actual AWS access
          AWS_ACCESS_KEY_ID: "test"
          AWS_SECRET_ACCESS_KEY: "test"
          AWS_DEFAULT_REGION: "us-east-1"

      - name: Terraform Show
        run: terraform show plan.out
        working-directory: ${{ matrix.module }}

  module-tests-summary:
    needs: [discover-modules, module-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.module-tests.result }}" == "failure" ]; then
            echo "Module tests failed"
            exit 1
          elif [ "${{ needs.discover-modules.outputs.modules }}" == "[]" ]; then
            echo "No test modules found - skipping tests"
          else
            echo "All module tests passed"
          fi
